<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ManJ1939_v.g.2.63_1230</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- [LOCKED AREA: GLOBAL & MAIN PAGE CSS FROM v.g.2.49] --- */
    :root {
      --bg: #f1f5f9; --panel: #ffffff; --text: #0f172a;
      --muted: #64748b; --accent: #2563eb; --line: rgba(0,0,0,.08);
      --radius: 12px; --header-h: 70px;
    }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); font-family: sans-serif; color: var(--text); overflow: hidden; }
    
    .header { background: #ffffff; width: 100%; height: var(--header-h); padding: 0 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-bottom: 1px solid var(--line); box-sizing: border-box; z-index: 1000; }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .header-logo { height: 45px; width: auto; max-width: 250px; object-fit: contain; }
    .header-title { font-size: 18px; font-weight: bold; color: #1e293b; }
    
    .main-wrapper { width: 100%; display: flex; height: calc(100vh - var(--header-h)); }
    .master-list { flex: 1; height: 100%; background: var(--panel); padding: 20px; border-right: 1px solid var(--line); transition: all 0.3s ease; overflow-y: auto; box-sizing: border-box; }
    
    .show-detail .master-list { flex: 0 0 280px; }
    .show-detail .master-list th:nth-child(n+3), .show-detail .master-list td:nth-child(n+3) { display: none !important; }
    .show-detail .header-tools { display: none !important; }

    .list-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .header-tools { display: flex; align-items: center; gap: 10px; }
    .view-select { padding: 4px 8px; font-size: 12px; border-radius: 6px; border: 1px solid #cbd5e1; background: #fff; cursor: pointer; color: var(--text); }
    .badge-sync { font-size: 11px; background: #ecfdf5; color: #10b981; padding: 4px 10px; border-radius: 20px; border: 1px solid #d1fae5; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .syncing svg { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 12px; color: var(--muted); border-bottom: 2px solid var(--bg); background: #f8fafc; position: sticky; top: 0; z-index: 10; }
    td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    tbody tr { cursor: pointer; transition: background 0.2s; }
    tbody tr:hover { background-color: #f8fafc; }
    tr.active { background: #eff6ff !important; color: var(--accent); font-weight: bold; border-left: 4px solid var(--accent); }
    
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
    .status-v { background: #10b981; box-shadow: 0 0 4px rgba(16,185,129,0.4); }
    .status-other { background: #cbd5e1; }

    .mode-simple { table-layout: fixed; }
    .mode-simple th:nth-child(1), .mode-simple td:nth-child(1) { width: 40px; text-align: center; }
    .mode-simple th:nth-child(2), .mode-simple td:nth-child(2) { width: 180px; }
    .mode-simple th:nth-child(3), .mode-simple td:nth-child(3) { width: 80px; }
    .mode-simple th:nth-child(4), .mode-simple td:nth-child(4) { width: 80px; }
    .mode-simple th:nth-child(5), .mode-simple td:nth-child(5) { width: 60px; text-align: center; }
    .mode-simple th:nth-child(6), .mode-simple td:nth-child(6) { width: 100px; }
    .mode-simple th:nth-child(7), .mode-simple td:nth-child(7) { width: auto; }

    /* --- [LOCKED AREA: SECTION 1 & 2 UI] --- */
    .detail-panel { flex: 0; opacity: 0; visibility: hidden; width: 0; background: var(--bg); transition: all 0.3s ease; overflow: hidden; }
    .show-detail .detail-panel { flex: 1; opacity: 1; visibility: visible; }
    .detail-card { background: white; width: 100%; height: 100%; padding: 30px; box-sizing: border-box; border-radius: var(--radius) 0 0 0; overflow-y: auto; position: relative; }
    .detail-title { font-size: 26px; font-weight: 800; margin-bottom: 12px; display: block; color: var(--text); letter-spacing: -0.5px; }
    .pill-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 24px; }
    .v138-pill { background: #f8fafc; color: #64748b; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid #e2e8f0; }
    .section-2-wrapper { margin-bottom: 30px; display: flex; align-items: center; gap: 15px; position: relative; z-index: 2000; flex-wrap: wrap; }
    .time-btn-group { display: flex; gap: 8px; align-items: center; position: relative; }
    .time-btn { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; color: #475569; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .time-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .range-display { font-size: 12px; color: var(--muted); font-family: monospace; padding-left: 12px; border-left: 3px solid var(--accent); line-height: 1.2; white-space: nowrap; }
    
    /* --- [UNLOCKED: SECTION 3 STYLING] --- */
    .tabs-v138 { display: flex; gap: 24px; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px; }
    .tab-item { padding: 12px 2px; cursor: pointer; color: var(--muted); font-weight: 600; font-size: 14px; position: relative; }
    .tab-item.active { color: var(--accent); }
    .tab-item.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2.5px; background: var(--accent); border-radius: 2px; }
    .render-area { height: 380px; width: 100%; background: #fafafa; border-radius: 12px; padding: 16px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; position: relative; }
    .kpi-container { text-align: center; animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .kpi-value { font-size: 72px; font-weight: 800; color: var(--accent); letter-spacing: -2px; }
    .kpi-unit { font-size: 22px; color: var(--muted); margin-top: 4px; font-weight: 600; }
    .close-panel { float: right; cursor: pointer; font-size: 24px; color: #cbd5e1; margin-top: -10px; }
  </style>
</head>
<body onload="initSync()">

  <header class="header">
    <div class="header-left">
      <img src="Logo_MAN.png" alt="Logo" class="header-logo" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/a/ad/MAN_Logo.svg/1200px-MAN_Logo.svg.png'">
      <div class="header-title">至遠至懋 車隊管理訊號總表 x 弋揚科技</div>
    </div>
    <div style="font-size: 11px; color: var(--muted);">v.g.2.63_1230</div>
  </header>

  <div class="main-wrapper" id="mainContainer">
    <div class="master-list">
      <div class="list-header">
        <h3 style="margin:0">訊號清單</h3>
        <div class="header-tools">
          <select id="viewMode" class="view-select" onchange="handleViewModeChange()">
            <option value="simple" selected>Simple View</option>
            <option value="full">Full View</option>
          </select>
          <span id="syncBadge" class="badge-sync" onclick="initSync()">
            <svg viewBox="0 0 24 24" width="12" height="12"><path fill="currentColor" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            <span id="syncText">Cloud Synced</span>
          </span>
        </div>
      </div>
      <table id="mainTable" class="mode-simple">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="detail-panel" id="detailPanel">
      <div class="detail-card">
        <span class="close-panel" onclick="closePanel()">&times;</span>
        <div id="section-1">
          <span class="detail-title" id="detailTitle">--</span>
          <div class="pill-container" id="pillArea"></div>
        </div>
        <div id="section-2" class="section-2-wrapper">
          <div class="time-btn-group">
            <button class="time-btn" onclick="setTimeRange('today', this)">今日</button>
            <button class="time-btn" onclick="setTimeRange('yesterday', this)">昨日</button>
            <button class="time-btn active" id="btnWeek" onclick="setTimeRange('week', this)">週</button>
            <button class="time-btn" id="btnMonth" onclick="setTimeRange('month', this)">月</button>
          </div>
          <div class="range-display" id="rangeText">--</div>
        </div>
        <div id="section-3">
          <div class="tabs-v138" id="tabsArea"></div>
          <div class="render-area" id="renderArea">
            <canvas id="mainChart"></canvas>
            <div id="kpiArea" class="kpi-container" style="display:none">
              <div class="kpi-value" id="kpiValue">--</div>
              <div class="kpi-unit" id="kpiUnit">--</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* --- [LOCKED LOGIC] --- */
    const PROXY_URL = "https://script.google.com/macros/s/AKfycbyuW4DJnmlwIqf2WsIqncMZJgVMArh_p7lA9S4DWBzo2TUOIRdmvX39XbywfS8HfcMK/exec";
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1E0fhR3-WS9X1_w64BqRa3yborhGRtV50E0ipHoMfXvg/edit";
    let sheetData = [], myChart = null, currentConfigs = [], currentTimeMode = 'week', currentTabIndex = 0;

    async function initSync() {
      const b = document.getElementById('syncBadge'); const t = document.getElementById('syncText');
      b.classList.add('syncing'); t.innerText = 'Syncing...';
      try {
        const res = await fetch(`${PROXY_URL}?url=${encodeURIComponent(SHEET_URL)}`, { redirect: 'follow' });
        sheetData = await res.json(); renderTable(sheetData);
        t.innerText = 'Cloud Synced';
      } catch (e) { t.innerText = 'Sync Failed'; }
      b.classList.remove('syncing');
    }

    /* --- [LOGIC MODIFIED: RELEASE SELECTION ON VIEW CHANGE] --- */
    function handleViewModeChange() {
        const mode = document.getElementById('viewMode').value;
        if (mode === 'full') {
            closePanel(); // 當切換至 Full View 時，自動釋放選取狀態
        }
        renderTable(sheetData);
    }

    function renderTable(data) {
      if (!data || data.length === 0) return;
      const mode = document.getElementById('viewMode').value;
      const head = document.getElementById('tableHead');
      const body = document.getElementById('tableBody');
      const hs = data[0];
      const simpleTargets = ["項目", "功能", "PGN", "SPN", "格碼", "至懋回傳", "呈現方式"];
      let targetIdx = mode==='simple' ? simpleTargets.map(t => hs.findIndex(h => h===t || (t==="項目" && h==="項目名稱"))) : hs.map((_,i)=>i);
      const gIdx = hs.indexOf("格碼");
      head.innerHTML = `<tr>${targetIdx.map(i => `<th>${hs[i]}</th>`).join('')}</tr>`;
      body.innerHTML = data.slice(1).map((row, idx) => {
        const dotColor = row[gIdx] === 'V' ? 'status-v' : 'status-other';
        return `<tr onclick="selectRow(${idx}, this)">${targetIdx.map(i => {
          if (hs[i] === "功能") return `<td><div style="display:flex;align-items:center;gap:8px;"><span class="status-dot ${dotColor}"></span>${row[i] || ''}</div></td>`;
          return `<td>${row[i] || ''}</td>`;
        }).join('')}</tr>`;
      }).join('');
    }

    function selectRow(idx, el) {
      document.querySelectorAll('tr').forEach(r => r.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('mainContainer').classList.add('show-detail');
      const row = sheetData[idx + 1], hs = sheetData[0];
      const getV = (n) => { let i = hs.findIndex(h => h === n || (n === "項目" && h === "項目名稱")); return i !== -1 ? row[i] : ''; };
      document.getElementById('detailTitle').innerText = `${getV('項目')} ${getV('功能')}`.trim();
      let pillHtml = '';
      hs.forEach((h, i) => { if(!["項目","項目名稱","功能","呈現方式"].includes(h) && row[i] && row[i]!=='--') pillHtml += `<span class="v138-pill">${h}: ${row[i]}</span>`; });
      document.getElementById('pillArea').innerHTML = pillHtml;
      currentConfigs = parseProtocol(row[hs.indexOf("呈現方式")]);
      currentTabIndex = 0;
      renderTabs();
    }

    /* --- [UNLOCKED: SECTION 3 BEAUTIFIED LOGIC] --- */
    function parseProtocol(str) {
      if (!str || !str.includes('tab:')) return [{ tab: '預設趨勢', view: 'line', range: [0, 100], unit: '' }];
      const segments = str.split(/(?=tab:)/).filter(s => s.trim().startsWith('tab:'));
      return segments.map(seg => {
        const obj = { tab: '未命名', view: 'line', range: [0, 100], unit: '' };
        seg.split('|').forEach(part => {
          const pair = part.split(':'); if (pair.length < 2) return;
          const k = pair[0].trim().toLowerCase(), v = pair.slice(1).join(':').trim();
          if (k === 'tab') obj.tab = v;
          else if (k === 'view') obj.view = v;
          else if (k === 'unit') obj.unit = v;
          else if (k === 'range') {
            const nums = v.match(/[\d.]+/g);
            if (nums && nums.length >= 2) obj.range = [parseFloat(nums[0]), parseFloat(nums[1])];
          }
        });
        return obj;
      });
    }

    function renderTabs() {
      const area = document.getElementById('tabsArea');
      area.innerHTML = currentConfigs.map((c, i) => `<div class="tab-item ${i===currentTabIndex?'active':''}" onclick="switchTab(${i}, this)">${c.tab}</div>`).join('');
      renderChartByTab();
    }

    function switchTab(idx, el) {
      currentTabIndex = idx;
      if(el) { document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active')); el.classList.add('active'); }
      renderChartByTab();
    }

    function renderChartByTab() {
      const cfg = currentConfigs[currentTabIndex]; if (!cfg) return;
      const canvas = document.getElementById('mainChart'), kpi = document.getElementById('kpiArea');
      if (cfg.view === 'kpi') {
        canvas.style.display = 'none'; kpi.style.display = 'block';
        document.getElementById('kpiValue').innerText = (Math.random()*(cfg.range[1]-cfg.range[0])+cfg.range[0]).toFixed(1);
        document.getElementById('kpiUnit').innerText = cfg.unit || '';
      } else {
        canvas.style.display = 'block'; kpi.style.display = 'none'; renderChart(cfg);
      }
    }

    function renderChart(cfg) {
      if (myChart) myChart.destroy();
      const labels = getTimelineLabels(currentTimeMode);
      const ctx = document.getElementById('mainChart').getContext('2d');
      const colors = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
      const bgColors = colors.map(c => c + 'cc');

      let gradient = null;
      if (cfg.view === 'line' || !cfg.view) {
        gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(37, 99, 235, 0.25)');
        gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');
      }

      const chartType = (cfg.view === 'pie') ? 'doughnut' : (cfg.view === 'bar' ? 'bar' : 'line');
      
      myChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: cfg.tab,
            data: labels.map(() => Math.random()*(cfg.range[1]-cfg.range[0])+cfg.range[0]),
            borderColor: (chartType === 'doughnut') ? '#fff' : colors[0],
            backgroundColor: (chartType === 'doughnut') ? bgColors : (chartType === 'bar' ? bgColors[0] : gradient),
            fill: true,
            tension: 0.4,
            borderWidth: (chartType === 'doughnut') ? 2 : 3,
            borderRadius: (chartType === 'bar') ? 6 : 0,
            pointRadius: (chartType === 'line') ? 0 : 3,
            pointHoverRadius: 6,
            hoverOffset: (chartType === 'doughnut') ? 15 : 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: (chartType === 'doughnut') ? '65%' : 0,
          plugins: {
            legend: { display: (chartType === 'doughnut'), position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
            tooltip: { backgroundColor: '#1e293b', padding: 12, cornerRadius: 8 }
          },
          scales: (chartType === 'doughnut') ? {} : {
            y: { beginAtZero: false, grid: { color: '#f1f5f9' }, ticks: { color: '#94a3b8' } },
            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
          }
        }
      });
    }

    function getTimelineLabels(mode) {
      const labels = []; const now = new Date();
      if (mode === 'today') { for (let i=11; i>=0; i--) { const d=new Date(now); d.setHours(now.getHours()-(i*2)); labels.push(`${d.getHours()}:00`); } }
      else if (mode === 'yesterday') { for (let i=0; i<24; i+=2) { labels.push(`${i}:00`); } }
      else if (mode === 'week') { for (let i=6; i>=0; i--) { const d=new Date(now); d.setDate(now.getDate()-i); labels.push(`${d.getMonth()+1}/${d.getDate()}`); } }
      else if (mode === 'month') { for (let i=29; i>=0; i--) { const d=new Date(now); d.setDate(now.getDate()-i); labels.push(`${d.getMonth()+1}/${d.getDate()}`); } }
      return labels;
    }

    function setTimeRange(type, el) {
      currentTimeMode = type;
      document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active')); el.classList.add('active');
      let end = new Date(), start = new Date();
      if (type === 'today') start.setHours(0,0,0,0);
      else if (type === 'yesterday') { start.setDate(start.getDate()-1); start.setHours(0,0,0,0); end.setDate(end.getDate()-1); end.setHours(23,59,59,999); }
      else if (type === 'week') start.setDate(start.getDate()-7);
      else if (type === 'month') start.setDate(start.getDate()-30);
      document.getElementById('rangeText').innerText = `${start.toLocaleDateString()} ~ ${end.toLocaleDateString()}`;
      renderChartByTab();
    }

    /* --- [MODIFIED: RELEASE SELECTION ON CLOSE] --- */
    function closePanel() {
        document.getElementById('mainContainer').classList.remove('show-detail');
        document.querySelectorAll('tr').forEach(r => r.classList.remove('active')); // 清除所有選取狀態
    }

    window.onload = () => { initSync(); setTimeRange('week', document.getElementById('btnWeek')); };
  </script>
</body>
</html>
